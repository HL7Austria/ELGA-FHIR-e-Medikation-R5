name: UpdateBallotComments

on:
  discussion:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  discussions: read

jobs:
  update-comments:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Ballot Comment Repo
        uses: actions/checkout@v4
        with:
          repository: HL7Austria/ballot-comments
          path: .

      - name: Set IG Subfolder name
        id: set_folder
        run: |
          BRANCH_NAME=${{ github.ref_name }}
          echo "Detected branch: $BRANCH_NAME"
          echo "IG_FOLDER=r5-ELGA-e-medikation-$BRANCH_NAME" >> $GITHUB_ENV

      - name: Fetch Discussions
        working-directory: ${{ env.IG_FOLDER }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FOLDER="discussions-${{ github.ref_name }}"
          mkdir -p "$FOLDER"
          echo '[]' > "$FOLDER/discussions-all.json"
          NEXT="first"

          while [ ! -z "$NEXT" ]; do
            echo "Fetching discussions after cursor: $NEXT"
            if [ "$NEXT" == "first" ]; then
              echo "Fetching first"
              RESPONSE=$(gh api graphql --field query='
                query {
                  repository(owner: "HL7Austria", name: "ELGA-FHIR-e-Medikation-R5") {
                    discussions(first: 10) {
                      pageInfo { endCursor hasNextPage }
                      nodes {
                        title
                        url
                        number
                        createdAt
                        category { name }
                      }
                    }
                  }
                }
              ')
            else
              echo "Fetching continuous"
              RESPONSE=$(gh api graphql --field query='
                query ($cursor: String!) {
                  repository(owner: "HL7Austria", name: "ELGA-FHIR-e-Medikation-R5") {
                    discussions(first: 10, after: $cursor) {
                      pageInfo { endCursor hasNextPage }
                      nodes {
                        title
                        url
                        number
                        createdAt
                        category { name }
                      }
                    }
                  }
                }
              ' -f cursor="$NEXT")
            fi

            echo "$RESPONSE" | jq '.data.repository.discussions.nodes' > $FOLDER/page.json

            # Merge with existing
            jq -s '.[0] + .[1]' $FOLDER/discussions-all.json $FOLDER/page.json > $FOLDER/merged.json
            mv $FOLDER/merged.json $FOLDER/discussions-all.json
            NEXT=$(echo "$RESPONSE" | jq -r '.data.repository.discussions.pageInfo | if .hasNextPage then .endCursor else "" end')
          done


      - name: Show fetched discussions
        working-directory: ${{ env.IG_FOLDER }}
        run: |
          cat "discussions-${{ github.ref_name }}/discussions-all.json" || echo "No discussions found"


      - name: Generate comments.json
        working-directory: ${{ env.IG_FOLDER }}
        shell: python
        run: |
          import os, json, base64

          folder = f'discussions-${os.environ["GITHUB_REF_NAME"]}'
          with open(f'{folder}/discussions-all.json', 'r') as f:
            all_discussions = json.load(f)

          comments = []
          for d in all_discussions:
            if d.get('category', {}).get('name') != 'Comment':
                continue
            try:
                decoded = base64.b64decode(d['title']).decode('utf-8')
                parts = decoded.split('|')
                if len(parts) != 5:
                  continue
                comments.append({
                    'page': parts[0],
                    'startXPath': parts[1],
                    'startOffset': int(parts[2]),
                    'endXPath': parts[3],
                    'endOffset': int(parts[4]),
                    'url': d['url'],
                    'createdAt': d['createdAt'],
                    'number': d['number']
                 })
            except Exception:
              continue

          with open(f'{folder}/comments.json', 'w') as f:
            json.dump(comments, f, indent=2)



      - name: Commit and push updated comments.json
        working-directory: ${{ env.IG_FOLDER }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f discussions-${{ github.ref_name }}/comments.json ]; then
            git add  discussions-${{ github.ref_name }}/comments.json
            git commit -m "Update comments.json from discussions event" || echo "No changes to commit"
            git push
          else
            echo "No comments.json generated. Skipping commit."
          fi